<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiteCase - Judgments, Library & News</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #111827;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .splash-overlay, .lock-overlay {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }

        .lock-overlay {
            z-index: 9998;
            display: none;
        }

        .loader-bar {
            width: 240px;
            height: 6px;
            background: #f3f4f6;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .loader-progress {
            width: 0%;
            height: 100%;
            background: #000000;
            transition: width 0.4s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }

        mark {
            background-color: #fef08a;
            color: #111827;
            padding: 0 1px;
            border-radius: 2px;
            font-weight: inherit;
        }

        .search-result-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid transparent;
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        .search-result-card:hover {
            transform: translateX(4px);
            border-left-color: #000;
            background: #fafafa;
        }

        #hero-container {
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #hero-container.has-results {
            min-height: 25vh;
            padding-bottom: 2rem;
        }

        .search-wrapper {
            width: 100%;
            max-width: 850px;
            position: relative;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #ffffff; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d1d5db; }

        .paragraph-content b, .paragraph-content strong { font-weight: 700; color: #000; }
        .paragraph-content i, .paragraph-content em { font-style: italic; }

        #copyToast {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }

        .passcode-input {
            letter-spacing: 0.5em;
            text-align: center;
            font-weight: 900;
            border-bottom: 2px solid #f3f4f6;
            transition: border-color 0.3s;
        }
        .passcode-input:focus {
            border-color: #000;
            outline: none;
        }

        .nav-tab {
            position: relative;
            padding: 0.5rem 1.5rem;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #9ca3af;
            transition: all 0.3s;
            cursor: pointer;
        }
        .nav-tab.active {
            color: #000;
        }
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 2px;
            background: #000;
        }
    </style>
</head>
<body>

    <!-- Sync Splash -->
    <div id="splash" class="splash-overlay">
        <div id="splash-content" class="flex flex-col items-center">
            <div class="flex items-center gap-1 mb-4 select-none">
                <span class="text-4xl font-black text-black tracking-tighter">Cite</span>
                <span class="text-4xl font-black bg-black text-white px-2 py-0.5 rounded-lg tracking-tighter">Case</span>
            </div>
            <div id="status-text" class="text-gray-400 font-medium text-[10px] tracking-[0.2em] uppercase animate-pulse">Syncing All Archives...</div>
            <div id="loader-container" class="loader-bar">
                <div id="progress" class="loader-progress"></div>
            </div>
            
            <div id="error-ui" class="hidden">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                <h2 class="text-lg font-bold mb-2 text-black text-center">Sync Failed</h2>
                <p id="error-message" class="text-sm text-gray-500 mb-6 text-center"></p>
                <button onclick="location.reload()" class="bg-black text-white px-8 py-2.5 rounded-xl font-bold shadow-sm hover:bg-gray-800 transition-all">
                    Retry Sync
                </button>
            </div>
        </div>
    </div>

    <!-- Passcode Screen -->
    <div id="lock-screen" class="lock-overlay">
        <div class="flex flex-col items-center w-full max-w-xs">
            <div class="flex items-center gap-1 mb-12 select-none opacity-20">
                <span class="text-2xl font-black text-black tracking-tighter">Cite</span>
                <span class="text-2xl font-black bg-black text-white px-1.5 py-0.5 rounded-md tracking-tighter">Case</span>
            </div>
            <input type="password" id="passcodeField" maxlength="8" class="passcode-input w-full py-4 text-2xl" autocomplete="off" autofocus placeholder="••••••••">
            <div id="lockError" class="mt-4 text-red-500 text-[10px] font-bold uppercase tracking-widest opacity-0 transition-opacity">Access Denied</div>
        </div>
    </div>

    <div id="copyToast">Copied to Clipboard</div>

    <div id="app-content" class="min-h-screen flex flex-col bg-white opacity-0 pointer-events-none transition-opacity duration-700">
        <!-- Navigation -->
        <nav class="flex justify-center gap-4 md:gap-8 py-6 border-b border-gray-50 bg-white/80 backdrop-blur-md sticky top-0 z-40">
            <button onclick="setView('ebooks')" id="tab-ebooks" class="nav-tab">Law Library</button>
            <button onclick="setView('judgments')" id="tab-judgments" class="nav-tab active">Supreme Court Judgments</button>
            <button onclick="setView('news')" id="tab-news" class="nav-tab">Legal News Hub</button>
        </nav>

        <div id="hero-container">
            <div class="flex flex-col items-center mb-12">
                <div class="flex items-center gap-1 cursor-pointer select-none" onclick="location.reload()">
                    <span class="text-5xl md:text-6xl font-black text-black tracking-tighter">Cite</span>
                    <span class="text-5xl md:text-6xl font-black bg-black text-white px-3 py-1 rounded-2xl tracking-tighter">Case</span>
                </div>
            </div>

            <div class="search-wrapper mx-auto">
                <div class="relative group">
                    <input type="text" id="searchInput" 
                        placeholder="Search Case Names, Neutral Citation Or Keywords" 
                        class="w-full pl-14 pr-6 py-5 bg-white border-2 border-gray-100 rounded-2xl focus:ring-8 focus:ring-gray-50 focus:border-black outline-none transition-all text-lg shadow-sm hover:border-gray-200">
                    <i class="fas fa-search absolute left-5 top-6 text-gray-300 text-xl group-focus-within:text-black transition-colors"></i>
                </div>

                <div id="searchControls" class="mt-8 flex flex-wrap gap-4 items-center justify-center text-sm">
                    <div class="flex items-center gap-8 mr-4">
                        <span class="font-bold uppercase tracking-widest text-[10px] text-gray-300">Search Logic</span>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-black transition-colors">
                            <input type="radio" name="logic" value="and" checked class="w-4 h-4 accent-black">
                            <span class="font-semibold text-gray-500">All Words</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-black transition-colors">
                            <input type="radio" name="logic" value="exact" class="w-4 h-4 accent-black">
                            <span class="font-semibold text-gray-500">Exact Match</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-black transition-colors">
                            <input type="radio" name="logic" value="or" class="w-4 h-4 accent-black">
                            <span class="font-semibold text-gray-500">Any Word</span>
                        </label>
                    </div>
                    
                    <div id="quickCiteGroup" class="flex flex-wrap items-center justify-center gap-2 border-l pl-4 border-gray-100">
                        <button onclick="quickSearch('2026 INSC ')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">Read Latest SC Judgments</button>
                        <button onclick="topicSearch('Constitution')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">Constitution</button>
                        <button onclick="topicSearch('civil procedure')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">CPC</button>
                        <button onclick="topicSearch('Arbitration')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">Arbitration</button>
                        <button onclick="topicSearch('IBC')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">IBC</button>
                        <button onclick="topicSearch('criminal procedure')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">CrPC</button>
                        <button onclick="topicSearch('Family')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">Family</button>
                    </div>

                    <div id="libraryQuickGroup" class="hidden flex-wrap items-center justify-center gap-2 border-l pl-4 border-gray-100">
                        <button onclick="topicSearch('Constitution')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">Constitution</button>
                        <button onclick="topicSearch('civil procedure')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">CPC</button>
                        <button onclick="topicSearch('Arbitration')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">Arbitration</button>
                        <button onclick="topicSearch('IBC')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">IBC</button>
                        <button onclick="topicSearch('criminal procedure')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">CrPC</button>
                        <button onclick="topicSearch('Family')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold">Family</button>
                        <button onclick="topicSearch('Criminal')" class="quick-cite-badge px-3 py-1 rounded-full text-[10px] font-bold bg-blue-50 text-blue-600 border-blue-100">Criminal Law</button>
                    </div>
                </div>
            </div>

            <div id="statsWrapper" class="flex flex-col items-center mt-10">
                <div id="initialStats" class="text-gray-400 text-[11px] font-bold uppercase tracking-[0.25em]">
                    Initializing archives...
                </div>
                <div id="heroNotebookLink" class="mt-6 hidden opacity-0 transition-opacity duration-500">
                    <a href="https://notebooklm.google.com/notebook/b451a149-6b7c-44da-96f0-bd946ea69b31" target="_blank" class="flex items-center gap-2 bg-gray-50 hover:bg-black hover:text-white text-gray-400 px-6 py-2.5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border border-gray-100">
                        <i class="fas fa-robot"></i> Chat with NotebookLM AI
                    </a>
                </div>
            </div>
        </div>

        <div id="results-wrapper" class="hidden">
            <div class="max-w-4xl mx-auto px-6 mb-8 flex justify-between items-center text-[10px] text-gray-400 font-bold uppercase tracking-[0.2em] border-b border-gray-50 pb-4">
                <div class="flex flex-wrap items-center gap-4">
                    <div id="statsCount">Found 0 items</div>
                    <button id="copyAllBtn" onclick="copyAllResults()" class="flex items-center gap-2 hover:text-black transition-colors border-l pl-4 border-gray-100">
                        <i class="fas fa-copy"></i> Copy Full Results
                    </button>
                </div>
                <div id="searchSpeed" class="text-gray-300 font-mono hidden sm:block"></div>
            </div>

            <main id="resultsList" class="max-w-4xl mx-auto px-6 space-y-6 pb-24">
                <!-- Data injected here -->
            </main>
        </div>
    </div>

    <footer class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-50 py-3 px-6 flex justify-between items-center text-[9px] text-gray-300 font-bold uppercase tracking-[0.2em] z-50">
        <div class="flex items-center gap-6">
            <span>CiteCase Archives &copy; 2026</span>
            <a href="https://notebooklm.google.com/notebook/b451a149-6b7c-44da-96f0-bd946ea69b31" target="_blank" class="hover:text-black transition-colors flex items-center gap-1">
                <i class="fas fa-external-link-alt"></i> NotebookLM AI
            </a>
        </div>
    </footer>

    <script>
        const SOURCES = [
            "https://raw.githubusercontent.com/citecase/I/refs/heads/main/2025INSC",
            "https://raw.githubusercontent.com/citecase/I/refs/heads/main/jan2026.md",
            "https://raw.githubusercontent.com/citecase/I/refs/heads/main/2024.md"
        ];
        const EBOOK_SOURCE = "https://raw.githubusercontent.com/citecase/library/refs/heads/main/ebooks.md";
        const NEWS_SOURCE = "https://raw.githubusercontent.com/citecase/I/refs/heads/main/news.md";
        const FEEDBACK_URL = "https://tally.so/r/rjaxB5";
        
        let judgmentData = [];
        let ebookData = [];
        let newsData = [];
        let currentView = 'judgments'; 
        let currentResults = [];

        const getEl = (id) => document.getElementById(id);

        function getPasscode() {
            const now = new Date();
            const d = String(now.getDate()).padStart(2, '0');
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const y = String(now.getFullYear());
            return `${d}${m}${y}`;
        }

        function setupPasscode() {
            const field = getEl('passcodeField');
            const error = getEl('lockError');
            const target = getPasscode();

            field.addEventListener('input', (e) => {
                error.style.opacity = '0';
                if (e.target.value.length === 8) {
                    if (e.target.value === target) {
                        unlockApp();
                    } else {
                        error.style.opacity = '1';
                        field.value = '';
                    }
                }
            });
        }

        function unlockApp() {
            const lock = getEl('lock-screen');
            const content = getEl('app-content');
            lock.style.opacity = '0';
            setTimeout(() => {
                lock.style.display = 'none';
                content.classList.remove('pointer-events-none');
                content.style.opacity = '1';
                getEl('searchInput').focus();
            }, 500);
        }

        function setView(view) {
            currentView = view;
            const input = getEl('searchInput');
            const citeGroup = getEl('quickCiteGroup');
            const libGroup = getEl('libraryQuickGroup');
            const copyBtn = getEl('copyAllBtn');

            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            getEl(`tab-${view}`).classList.add('active');
            
            input.value = '';
            
            if (view === 'judgments') {
                input.placeholder = "Search Case Names, Neutral Citation Or Keywords";
                citeGroup.style.display = 'flex';
                libGroup.style.display = 'none';
                copyBtn.style.display = 'block';
                getEl('hero-container').classList.remove('has-results');
                getEl('results-wrapper').classList.add('hidden');
                getEl('statsWrapper').classList.remove('hidden');
            } else if (view === 'ebooks') {
                input.placeholder = "Search Law Library Titles Or Keywords...";
                citeGroup.style.display = 'none';
                libGroup.style.display = 'flex';
                copyBtn.style.display = 'none';
                getEl('hero-container').classList.remove('has-results');
                getEl('results-wrapper').classList.add('hidden');
                getEl('statsWrapper').classList.remove('hidden');
            } else {
                input.placeholder = "Search Legal News Hub...";
                citeGroup.style.display = 'none';
                libGroup.style.display = 'none';
                copyBtn.style.display = 'none';
                
                if (newsData.length > 0) {
                    renderResults(newsData.slice(0, 50), "");
                    getEl('hero-container').classList.add('has-results');
                    getEl('results-wrapper').classList.remove('hidden');
                    getEl('statsWrapper').classList.add('hidden');
                    getEl('statsCount').innerText = `Displaying ${newsData.length} Recent Stories`;
                }
            }
            
            updateStatsCount();
        }

        function updateStatsCount() {
            const stats = getEl('initialStats');
            if (currentView === 'judgments') {
                stats.innerText = `${judgmentData.length} Supreme Court Judgments Indexed`;
            } else if (currentView === 'ebooks') {
                stats.innerText = `${ebookData.length} Law Library Items Indexed`;
            } else {
                stats.innerText = `${newsData.length} News Articles Tracked`;
            }
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            showToast("Copied to Clipboard");
            document.body.removeChild(textarea);
        }

        function copyAllResults() {
            if (currentView !== 'judgments' || currentResults.length === 0) return;
            const compiledText = currentResults.map(doc => {
                const header = `${doc.title} ${doc.citation}`.trim();
                const notes = doc.paragraphs.join('\n\n');
                return `${header}\n${notes}`;
            }).join('\n\n' + '='.repeat(20) + '\n\n');
            copyToClipboard(compiledText);
        }

        function showToast(msg) {
            const toast = getEl('copyToast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2000);
        }

        function quickSearch(val) {
            const input = getEl('searchInput');
            if (input) {
                const exactRadio = document.querySelector('input[name="logic"][value="exact"]');
                if (exactRadio) exactRadio.checked = true;
                input.value = val;
                input.focus();
                performSearch();
            }
        }

        function topicSearch(val) {
            const input = getEl('searchInput');
            if (input) {
                const andRadio = document.querySelector('input[name="logic"][value="and"]');
                if (andRadio) andRadio.checked = true;
                input.value = val;
                input.focus();
                performSearch();
            }
        }

        function parseWikiMarkdown(markdown) {
            const lines = markdown.split('\n');
            const entries = [];
            let currentEntry = null;
            const linkRegex = /\[(.*?)\]\((https?:\/\/.*?)\)/;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                const match = trimmedLine.match(linkRegex);
                if (match) {
                    if (currentEntry) entries.push(currentEntry);
                    const label = match[1].replace(/\*\*/g, '').replace(/#/g, '').trim();
                    const url = match[2];
                    const citeRegex = /(202[4-6]\s+INSC\s+\d+)/i;
                    const citeMatch = label.match(citeRegex);
                    
                    let citation = "Citation N/A", title = label;
                    if (citeMatch) {
                        citation = citeMatch[1];
                        title = label.replace(citation, '').replace(/^\s*-\s*/, '').replace(/\s*-\s*$/, '').trim();
                    } else {
                        const parts = label.split(' - ');
                        if (parts.length > 1) { title = parts[0].trim(); citation = parts.slice(1).join(' - ').trim(); }
                    }

                    currentEntry = { id: Math.random(), title, citation, link: url, paragraphs: [] };
                } else if (currentEntry) {
                    if (!/^[-*_=]{3,}$/.test(trimmedLine)) currentEntry.paragraphs.push(trimmedLine);
                }
            });
            if (currentEntry) entries.push(currentEntry);
            return entries;
        }

        function parseSimpleMarkdown(markdown) {
            const entries = [];
            const linkRegex = /\[(.*?)\]\((https?:\/\/.*?)\)/g;
            let match;
            while ((match = linkRegex.exec(markdown)) !== null) {
                const title = match[1].replace(/\*\*/g, '').trim();
                const link = match[2].trim();
                if (title && link) entries.push({ title, link });
            }
            return entries;
        }

        async function initializeApp() {
            try {
                const cacheBuster = `?t=${Date.now()}`;
                updateProgress(10, `Downloading judgments...`);
                let totalJudgments = [];
                for (let i = 0; i < SOURCES.length; i++) {
                    try {
                        const response = await fetch(`${SOURCES[i]}${cacheBuster}`, { cache: "no-store" });
                        if (response.ok) totalJudgments = totalJudgments.concat(parseWikiMarkdown(await response.text()));
                    } catch (e) { console.error(e); }
                }
                judgmentData = totalJudgments;

                updateProgress(50, `Syncing library...`);
                try {
                    const ebookResponse = await fetch(`${EBOOK_SOURCE}${cacheBuster}`, { cache: "no-store" });
                    if (ebookResponse.ok) ebookData = parseSimpleMarkdown(await ebookResponse.text());
                } catch (e) { console.error(e); }

                updateProgress(70, `Connecting News Hub...`);
                try {
                    const newsResponse = await fetch(`${NEWS_SOURCE}${cacheBuster}`, { cache: "no-store" });
                    if (newsResponse.ok) newsData = parseWikiMarkdown(await newsResponse.text());
                } catch (e) { console.error(e); }

                updateProgress(100, "Ready");
                setTimeout(() => {
                    getEl('splash').style.opacity = '0';
                    setTimeout(() => {
                        getEl('splash').style.display = 'none';
                        updateStatsCount();
                        getEl('heroNotebookLink').classList.remove('hidden');
                        getEl('heroNotebookLink').style.opacity = '1';
                        getEl('lock-screen').style.display = 'flex';
                        setupPasscode();
                    }, 500);
                }, 400);
            } catch (error) { showError(error.message); }
        }

        function updateProgress(val, text) {
            const progress = getEl('progress');
            const status = getEl('status-text');
            if (progress) progress.style.width = val + '%';
            if (status) status.innerText = text;
        }

        function showError(msg) {
            getEl('status-text').style.display = 'none';
            getEl('loader-container').style.display = 'none';
            getEl('error-ui').classList.remove('hidden');
            getEl('error-message').innerText = msg;
        }

        function performSearch() {
            const input = getEl('searchInput');
            const queryRaw = input.value.toLowerCase();
            const queryTrimmed = queryRaw.trim();
            const logic = document.querySelector('input[name="logic"]:checked').value;
            const startTime = performance.now();

            if (queryTrimmed.length < (currentView === 'ebooks' ? 2 : 4)) {
                if (currentView === 'news') {
                    renderResults(newsData.slice(0, 50), "");
                    getEl('statsCount').innerText = `Displaying ${newsData.length} Recent Stories`;
                } else {
                    getEl('hero-container').classList.remove('has-results');
                    getEl('results-wrapper').classList.add('hidden');
                    getEl('statsWrapper').classList.remove('hidden');
                }
                return;
            }

            getEl('hero-container').classList.add('has-results');
            getEl('results-wrapper').classList.remove('hidden');
            getEl('statsWrapper').classList.add('hidden');

            let pool = [];
            if (currentView === 'judgments') pool = judgmentData;
            else if (currentView === 'ebooks') pool = ebookData;
            else pool = newsData;

            const terms = queryTrimmed.split(/\s+/).filter(t => t.length > 0);

            const scoredPool = pool.map(doc => {
                const searchString = currentView === 'ebooks' 
                    ? `${doc.title}`.toLowerCase()
                    : `${doc.title} ${doc.citation || ''} ${(doc.paragraphs || []).join(' ')}`.toLowerCase();
                
                let matchCount = 0;
                if (logic === 'exact') {
                    const escapedQuery = queryTrimmed.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    if (new RegExp(`\\b${escapedQuery}\\b`, 'i').test(searchString)) {
                        matchCount = 100;
                    }
                } else if (logic === 'or') {
                    terms.forEach(t => { if (searchString.includes(t)) matchCount++; });
                } else {
                    const allFound = terms.every(t => searchString.includes(t));
                    if (allFound) matchCount = terms.length;
                }

                return { ...doc, matchCount };
            });

            currentResults = scoredPool.filter(doc => doc.matchCount > 0);

            currentResults.sort((a, b) => {
                if (b.matchCount !== a.matchCount) return b.matchCount - a.matchCount;

                if (currentView === 'judgments') {
                    const extractYear = (c) => parseInt(c.match(/\b202[4-6]\b/)?.[0] || 0);
                    const extractNum = (c) => parseInt(c.match(/INSC\s+(\d+)/i)?.[1] || 0);
                    const yearA = extractYear(a.citation), yearB = extractYear(b.citation);
                    if (yearA !== yearB) return yearB - yearA;
                    return extractNum(b.citation) - extractNum(a.citation);
                } else {
                    return a.title.localeCompare(b.title);
                }
            });

            renderResults(currentResults, queryTrimmed);
            getEl('statsCount').innerText = `Found ${currentResults.length} matches`;
            getEl('searchSpeed').innerText = `${(performance.now() - startTime).toFixed(1)}ms`;
        }

        function highlightAndFormat(text, query) {
            if (!text) return "";
            let processed = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const logic = document.querySelector('input[name="logic"]:checked').value;
            
            if (query) {
                if (logic === 'exact') {
                    const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    processed = processed.replace(new RegExp(`(\\b${escapedQuery}\\b)`, 'gi'), '<mark>$1</mark>');
                } else {
                    const terms = query.split(/\s+/).filter(t => t.length > 2).sort((a,b)=>b.length-a.length);
                    if (terms.length > 0) {
                        const escapedTerms = terms.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
                        processed = processed.replace(new RegExp(`(${escapedTerms})`, 'gi'), '<mark>$1</mark>');
                    }
                }
            }
            return processed;
        }

        function getNewsBtnLabel(url) {
            if (!url) return 'READ FULL STORY';
            const lowerUrl = url.toLowerCase();
            if (lowerUrl.includes('verdictum.in')) return 'Read Verdictum Story';
            if (lowerUrl.includes('livelaw.in')) return 'Read LiveLaw Story';
            if (lowerUrl.includes('barandbench.com')) return 'Read Bar & Bench Story';
            return 'READ FULL STORY';
        }

        function renderResults(data, query = "") {
            const list = getEl('resultsList');
            if (!list) return;
            if (data.length === 0) { list.innerHTML = `<div class="py-24 text-center text-gray-400"><p class="text-[10px] font-bold uppercase tracking-[0.2em]">No results found</p></div>`; return; }

            if (currentView === 'judgments' || currentView === 'news') {
                list.innerHTML = data.map(doc => `
                    <div class="search-result-card bg-white p-7 rounded-2xl border border-gray-100 shadow-sm relative overflow-hidden mb-6">
                        <div class="flex flex-col md:flex-row md:items-start justify-between gap-6 mb-4">
                            <div class="flex-1">
                                ${currentView === 'judgments' ? `<div class="text-[8px] font-bold text-blue-500 uppercase tracking-[0.2em] mb-2">SC Judgment</div>` : ''}
                                <h3 class="text-xl font-bold text-black leading-tight mb-2 tracking-tight">${highlightAndFormat(doc.title, query)}</h3>
                                ${doc.citation && doc.citation !== 'Citation N/A' ? `<div class="text-xs font-mono text-gray-400 font-bold tracking-tight">${highlightAndFormat(doc.citation, query)}</div>` : ''}
                            </div>
                            <div class="flex flex-wrap items-center gap-2 shrink-0 select-none">
                                <button onclick="copyToClipboard('${doc.title.replace(/'/g, "\\'")}')" class="flex items-center justify-center bg-gray-50 hover:bg-gray-100 text-gray-400 hover:text-black w-10 h-10 rounded-xl transition-all border border-gray-100" title="Copy Heading"><i class="fas fa-copy"></i></button>
                                
                                <a href="${doc.link}" target="_blank" class="flex items-center justify-center gap-2 bg-black hover:bg-gray-800 text-white px-5 py-2.5 rounded-xl text-[10px] font-bold tracking-wider transition-all">
                                    <i class="fas ${currentView === 'news' ? 'fa-external-link-alt' : 'fa-file-pdf'}"></i> ${currentView === 'news' ? getNewsBtnLabel(doc.link) : 'VIEW PDF'}
                                </a>

                                ${currentView === 'news' ? `
                                <a href="${FEEDBACK_URL}" target="_blank" class="flex items-center justify-center gap-2 bg-red-50 hover:bg-red-100 text-red-500 px-4 py-2.5 rounded-xl text-[9px] font-bold tracking-tight transition-all border border-red-100" title="Report issue if link is restricted">
                                    <i class="fas fa-exclamation-circle"></i> REPORT ISSUE
                                </a>` : ''}
                            </div>
                        </div>
                        <div class="space-y-4 pt-5 border-t border-gray-50">${(doc.paragraphs || []).map(p => `<p class="paragraph-content text-[15px] text-gray-600 leading-relaxed font-[450]">${highlightAndFormat(p, query)}</p>`).join('')}</div>
                    </div>`).join('');
            } else {
                list.innerHTML = data.map(book => `
                    <div class="search-result-card bg-white p-6 rounded-2xl border border-gray-100 shadow-sm relative mb-4">
                        <div class="flex items-center justify-between gap-6">
                            <div class="flex-1">
                                <div class="text-[9px] font-bold text-blue-500 uppercase tracking-[0.2em] mb-1">Law Library</div>
                                <h3 class="text-lg font-bold text-black leading-tight tracking-tight">${highlightAndFormat(book.title, query)}</h3>
                            </div>
                            <a href="${book.link}" target="_blank" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl text-[10px] font-bold tracking-wider transition-all shadow-sm">
                                <i class="fas fa-book-open"></i> OPEN BOOK
                            </a>
                        </div>
                    </div>`).join('');
            }
        }

        window.setView = setView;
        window.quickSearch = quickSearch;
        window.topicSearch = topicSearch;
        window.copyAllResults = copyAllResults;
        window.performSearch = performSearch;
        window.copyToClipboard = copyToClipboard;

        getEl('searchInput').addEventListener('input', performSearch);
        document.querySelectorAll('input[name="logic"]').forEach(el => el.addEventListener('change', performSearch));
        initializeApp();
    </script>
</body>
</html>
